---
// src/pages/blog/[...slug].astro - 增强图片/视频响应式、灯箱导航及元数据统计修复版
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { SITE_CONFIG } from '../../data/site-config';

export async function getStaticPaths() {
    const blogEntries = await getCollection('blog');
    if (!blogEntries) return [];

    const sortedEntries = blogEntries.sort((a, b) =>
        new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
    );

    return sortedEntries.map((entry) => {
        const currentLang = entry.data.lang || 'ja';
        const sameLangPosts = sortedEntries.filter(
            (post) => (post.data.lang || 'ja') === currentLang
        );
        const currentIndex = sameLangPosts.findIndex((p) => p.id === entry.id);

        return {
            params: {
                slug: entry.id.replace(/\.(md|mdx)$/, '')
            },
            props: {
                entry,
                nextPost: currentIndex > 0 ? sameLangPosts[currentIndex - 1] : null,
                prevPost: currentIndex < sameLangPosts.length - 1 ? sameLangPosts[currentIndex + 1] : null,
            },
        };
    });
}

const { entry, prevPost, nextPost } = Astro.props;

if (!entry) return Astro.redirect('/404');
const { Content, headings } = await render(entry);

const {
    title,
    date,
    category,
    tags,
    coverImage,
    summary,
    lang = 'ja',
    series
} = entry.data;

// 计算字数与阅读时间
const wordCount = entry.body ? entry.body.length : 0;
const readingTime = Math.ceil(wordCount / 400);

const postDescription = summary;
const toc = (headings || []).filter((h) => h.depth === 2 || h.depth === 3);

const postUI = {
    back: { ja: "一覧に戻る", en: "Back to List" },
    toc: { ja: "目次内容", en: "CONTENTS" },
    prev: { ja: "前の記事", en: "PREVIOUS" },
    next: { ja: "次の記事", en: "NEXT" },
    returnIdx: { ja: "記事一覧へ戻る", en: "Return to Index" },
    stats: {
        words: { ja: "文字", en: "words" },
        minutes: { ja: "分", en: "min" }
    }
};

const getPostUrl = (id: string) => `/blog/${id.replace(/\.(md|mdx)$/, '')}`;
---

<BaseLayout
        title={title}
        description={postDescription}
        image={coverImage}
        article={true}
        lang={lang as 'ja' | 'en'}
>
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 text-left">
        <!-- 侧边栏 -->
        <aside class="hidden lg:block lg:col-span-3">
            <div class="sticky top-32 space-y-10">
                <a href="/blog" class="flex items-center gap-2 text-sm text-[var(--subtext)] hover:text-[var(--accent)] transition group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:-translate-x-1 transition-transform"><path d="m15 18-6-6 6-6"/></svg>
                    <span>{postUI.back[lang]}</span>
                </a>

                {series && (
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-[var(--pink)]">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                                <span>{series.title[lang]}</span>
                            </div>
                            <div class="flex flex-col text-[11px] bg-white/[0.02] rounded-2xl overflow-hidden border border-white/5 font-bold">
                                {series.items.map((item, idx) => (
                                        <a href={item.href} class={`p-3 border-b border-white/5 last:border-0 hover:bg-white/5 flex gap-3 ${item.active ? 'bg-[var(--accent)]/10 text-[var(--accent)] border-r-2 border-r-[var(--accent)]' : 'text-[var(--subtext)]'}`}>
                                            <span class="opacity-30">{String(idx + 1).padStart(2, '0')}</span>
                                            <span class="flex-1 truncate text-left">{item.title[lang]}</span>
                                            {item.active && <div class="w-1 h-1 rounded-full bg-[var(--accent)] mt-1.5 animate-pulse"></div>}
                                        </a>
                                ))}
                            </div>
                        </div>
                )}

                {toc.length > 0 && (
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-[var(--accent)]">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="21" x2="3" y1="6"/><line x1="15" x2="3" y1="12"/><line x1="17" x2="3" y1="18"/></svg>
                                <span>{postUI.toc[lang]}</span>
                            </div>
                            <nav class="flex flex-col gap-1 text-[11px] font-bold text-[var(--subtext)] border-l border-white/5">
                                {toc.map((h) => (
                                        <a href={`#${h.slug}`} class={`pl-6 py-2 border-l-2 border-transparent hover:border-[var(--accent)] hover:text-white transition-all truncate ${h.depth === 3 ? 'ml-4 opacity-70 text-[10px]' : ''}`}>
                                            {h.text}
                                        </a>
                                ))}
                            </nav>
                        </div>
                )}
            </div>
        </aside>

        <!-- 内容区 -->
        <article class="lg:col-span-9 xl:col-span-8 mx-auto w-full max-w-3xl">
            <header class="mb-16 space-y-8">
                <div class="flex flex-wrap items-center gap-y-4 gap-x-6 text-[10px] font-black font-mono tracking-widest uppercase">
                    <div class="flex items-center gap-2">
                        <span class="px-3 py-1 bg-[var(--accent)]/10 text-[var(--accent)] rounded-md border border-[var(--accent)]/20">{category}</span>
                        <span class="text-gray-500">{date}</span>
                    </div>
                    <div class="flex items-center gap-4 text-gray-500 border-l border-white/10 pl-6">
                        <div class="flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-[var(--pink)]"><path d="M4 13.5V4a2 2 0 0 1 2-2h8.5L20 7.5V20a2 2 0 0 1-2 2H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                            <span>{wordCount} {postUI.stats.words[lang]}</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-[var(--accent)]"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            <span>{readingTime} {postUI.stats.minutes[lang]}</span>
                        </div>
                    </div>
                </div>

                <h1 class="text-5xl md:text-6xl font-black text-white leading-[1.1] tracking-tight text-left">
                    {title}
                </h1>

                <div class="flex flex-wrap gap-3">
                    {tags.map((tag) => (
                            <span class="px-3 py-1 bg-white/5 text-[var(--subtext)] rounded-lg text-[9px] border border-white/10 font-mono font-bold hover:border-[var(--accent)]/40 transition-colors">#{tag}</span>
                    ))}
                </div>

                {coverImage && (
                        <div class="rounded-[2.5rem] overflow-hidden border border-white/5 aspect-video bg-white/5 shadow-2xl relative group cursor-zoom-in" id="blog-cover-container">
                            <img src={coverImage} class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" alt={title} />
                            <div class="absolute inset-0 bg-gradient-to-t from-bg via-transparent to-transparent opacity-50"></div>
                        </div>
                )}
            </header>

            <div class="article-content prose prose-invert max-w-none mb-20" id="blog-content">
                <Content />
            </div>

            <nav class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-white/10 pt-20 mt-32">
                {prevPost ? (
                        <a href={getPostUrl(prevPost.id)} class="p-8 bg-white/[0.02] hover:bg-white/5 border border-white/5 rounded-[2.5rem] transition-all group">
                            <span class="text-[10px] font-mono uppercase tracking-widest text-[var(--subtext)]">{postUI.prev[lang]}</span>
                            <p class="text-lg font-bold text-white mt-2 line-clamp-2 group-hover:text-[var(--accent)] transition-colors">{prevPost.data.title}</p>
                        </a>
                ) : (
                        <div class="p-8 bg-white/[0.01] border border-dashed border-white/5 rounded-[2.5rem] opacity-30 flex flex-col justify-center">
                            <span class="text-[10px] font-mono uppercase tracking-widest text-[var(--subtext)]">End of Road</span>
                            <p class="text-sm font-bold text-white mt-2">これが最初の記事です</p>
                        </div>
                )}

                {nextPost ? (
                        <a href={getPostUrl(nextPost.id)} class="p-8 bg-[var(--accent)]/5 hover:bg-[var(--accent)]/10 border border-[var(--accent)]/10 rounded-[2.5rem] transition-all text-right group">
                            <span class="text-[10px] font-mono text-[var(--accent)] uppercase tracking-widest group-hover:translate-x-1 transition-transform inline-block">{postUI.next[lang]}</span>
                            <p class="text-lg font-bold text-white mt-2 line-clamp-2">{nextPost.data.title}</p>
                        </a>
                ) : (
                        <a href="/blog" class="p-8 bg-white/[0.02] hover:bg-white/5 border border-white/10 rounded-[2.5rem] transition-all text-right group flex flex-col items-end shadow-lg">
                            <span class="text-[10px] font-mono text-[var(--accent)] uppercase tracking-widest group-hover:translate-x-1 transition-transform inline-block">{postUI.next[lang]}</span>
                            <span class="text-lg font-bold text-white mt-2 leading-tight">{postUI.returnIdx[lang]}</span>
                        </a>
                )}
            </nav>
        </article>
    </div>

    <!-- 动态灯箱容器 -->
    <div id="blog-lightbox" class="fixed inset-0 z-[1000] hidden flex-col items-center justify-center bg-[#1e1e2e]/95 backdrop-blur-2xl p-4 md:p-10" aria-hidden="true">
        <button id="lightbox-close" class="absolute top-6 right-6 text-white/50 hover:text-white transition-colors p-4 z-[1010]">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>

        <button id="lightbox-prev" class="absolute left-4 md:left-10 top-1/2 -translate-y-1/2 p-4 text-white/30 hover:text-white transition-all bg-white/5 hover:bg-white/10 rounded-full z-[1010] hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </button>
        <button id="lightbox-next" class="absolute right-4 md:right-10 top-1/2 -translate-y-1/2 p-4 text-white/30 hover:text-white transition-all bg-white/5 hover:bg-white/10 rounded-full z-[1010] hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
        </button>

        <div class="relative flex flex-col items-center justify-center max-w-full max-h-full cursor-default" onclick="event.stopPropagation()">
            <img id="lightbox-img" src="" alt="Large View" class="max-w-full max-h-[80vh] rounded-[2rem] object-contain shadow-2xl animate-in zoom-in-95 duration-300" />
            <div class="mt-6 flex flex-col items-center gap-2">
                <p id="lightbox-caption" class="font-mono text-[10px] text-[var(--accent)] uppercase tracking-[0.3em] font-black text-center max-w-xl"></p>
                <span id="lightbox-counter" class="text-[9px] font-mono text-white/20 font-bold tracking-widest bg-white/5 px-3 py-1 rounded-full"></span>
            </div>
        </div>
    </div>
</BaseLayout>

<script is:inline define:vars={{ lang }}>
    let allImages = [];
    let currentIndex = 0;

    function initBlogMedia() {
        allImages = [];
        const content = document.getElementById('blog-content');
        const coverContainer = document.getElementById('blog-cover-container');
        const lightbox = document.getElementById('blog-lightbox');
        const lbImg = document.getElementById('lightbox-img');
        const lbCaption = document.getElementById('lightbox-caption');
        const lbCounter = document.getElementById('lightbox-counter');
        const btnPrev = document.getElementById('lightbox-prev');
        const btnNext = document.getElementById('lightbox-next');
        const btnClose = document.getElementById('lightbox-close');

        if (!lightbox || !lbImg) return;

        // 1. 处理图片 (封面图)
        if (coverContainer) {
            const img = coverContainer.querySelector('img');
            if (img) {
                const globalIdx = allImages.length;
                allImages.push({ src: img.src, alt: img.alt });
                coverContainer.onclick = () => openLightbox(globalIdx);
            }
        }

        // 2. 处理正文媒体 (图片与视频 iframe)
        if (content) {
            // 图片处理
            const images = content.querySelectorAll('img');
            images.forEach((img) => {
                const globalIdx = allImages.length;
                allImages.push({ src: img.src, alt: img.alt });

                img.style.maxWidth = "100%";
                img.style.maxHeight = "360px";
                img.style.width = "100%";
                img.style.height = "100%";
                img.style.objectFit = "cover";
                img.style.objectPosition = "center";
                img.style.cursor = "zoom-in";
                img.style.borderRadius = "1.25rem";
                img.style.margin = "3.5rem auto";
                img.style.display = "block";
                img.style.border = "1px solid rgba(255,255,255,0.08)";
                img.style.boxShadow = "0 30px 60px -15px rgba(0, 0, 0, 0.5)";

                img.onclick = () => openLightbox(globalIdx);
            });

            // 视频 iframe 响应式处理
            const iframes = content.querySelectorAll('iframe');
            iframes.forEach((iframe) => {
                const w = parseInt(iframe.getAttribute('width') || "560");
                const h = parseInt(iframe.getAttribute('height') || "315");
                const isVertical = h > w; // 判断是否为纵屏视频 (如 Shorts)

                iframe.style.width = "100%";
                iframe.style.height = "auto";
                iframe.style.aspectRatio = `${w} / ${h}`;
                iframe.style.borderRadius = "1.5rem";
                iframe.style.margin = "4rem auto";
                iframe.style.display = "block";
                iframe.style.border = "1px solid rgba(255,255,255,0.08)";
                iframe.style.boxShadow = "0 40px 80px -20px rgba(0, 0, 0, 0.6)";

                // 如果是纵屏视频，限制桌面端宽度，防止占据过多空间
                if (isVertical) {
                    iframe.style.maxWidth = "420px";
                }
            });
        }

        function updateLightbox() {
            const current = allImages[currentIndex];
            if (!current) return;

            lbImg.src = current.src;
            lbCaption.textContent = current.alt || "";
            lbCounter.textContent = `${currentIndex + 1} / ${allImages.length}`;

            if (allImages.length > 1) {
                btnPrev.classList.remove('hidden');
                btnNext.classList.remove('hidden');
            } else {
                btnPrev.classList.add('hidden');
                btnNext.classList.add('hidden');
            }
        }

        function openLightbox(index) {
            currentIndex = index;
            updateLightbox();
            lightbox.classList.remove('hidden');
            lightbox.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            lightbox.classList.add('hidden');
            lightbox.classList.remove('flex');
            document.body.style.overflow = '';
            lbImg.src = "";
        }

        window.blogLightboxNext = () => {
            currentIndex = (currentIndex + 1) % allImages.length;
            updateLightbox();
        };

        window.blogLightboxPrev = () => {
            currentIndex = (currentIndex - 1 + allImages.length) % allImages.length;
            updateLightbox();
        };

        btnPrev.onclick = (e) => { e.stopPropagation(); window.blogLightboxPrev(); };
        btnNext.onclick = (e) => { e.stopPropagation(); window.blogLightboxNext(); };
        btnClose.onclick = closeLightbox;
        lightbox.onclick = closeLightbox;

        document.onkeydown = (e) => {
            if (lightbox.classList.contains('hidden')) return;
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowRight') window.blogLightboxNext();
            if (e.key === 'ArrowLeft') window.blogLightboxPrev();
        };
    }

    initBlogMedia();
    document.addEventListener('astro:after-swap', initBlogMedia);
</script>

<style is:global>
    .article-content h2 {
        font-size: 2.25rem; font-weight: 900; font-style: italic; color: #ffffff;
        line-height: 1.1; margin: 5rem 0 1.5rem; position: relative; padding-left: 1.5rem; border-left: 6px solid var(--accent);
    }
    .article-content h2 + * { border-top: 1px solid rgba(137, 180, 250, 0.2); padding-top: 2rem; }
    .article-content h3 { font-size: 1.5rem; font-weight: 800; color: var(--accent); margin: 3.5rem 0 1.5rem; }
    .article-content p { font-size: 1.1rem; line-height: 2.1; color: var(--subtext); margin-bottom: 2.5rem; letter-spacing: 0.015em; text-align: left; }
    .article-content blockquote {
        background: rgba(137, 180, 250, 0.04); border-left: 4px solid var(--accent);
        padding: 2.5rem; border-radius: 1.5rem; margin: 4rem 0; color: var(--text); line-height: 1.8; text-align: left;
    }
    .article-content ul, .article-content ol { margin-bottom: 2.5rem; text-align: left; }
    .article-content li { position: relative; padding-left: 2rem; margin-bottom: 1.2rem; color: var(--subtext); line-height: 1.8; }
    .article-content li::before { content: ""; position: absolute; left: 0; top: 0.8em; width: 8px; height: 2px; background: var(--accent); }
    .article-content strong { color: #ffffff; font-weight: 900; }

    .article-content img, .article-content iframe {
        transition: all 0.5s cubic-bezier(0.2, 1, 0.3, 1);
    }
    .article-content img:hover {
        transform: translateY(-8px) scale(1.005);
        box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.7);
        border-color: rgba(137, 180, 250, 0.5) !important;
    }

    :target { scroll-margin-top: 120px; }
</style>