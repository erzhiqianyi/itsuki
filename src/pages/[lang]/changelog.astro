---
// src/pages/[lang]/changelog.astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { Icon } from 'astro-icon/components';
import { SITE_CONFIG } from '../../data/site-config';

// 1. 生成多语言路径
export async function getStaticPaths() {
    return [{ params: { lang: 'ja' } }, { params: { lang: 'en' } }];
}

const { lang } = Astro.params as { lang: 'ja' | 'en' };

// 2. 翻译辅助函数 (从配置文件读取)
const t = (key: string) => {
    const labels = SITE_CONFIG.ui.labels as any;
    const headings = SITE_CONFIG.ui.headings as any;
    return labels[key]?.[lang] || headings[key]?.[lang] || key;
};

// 3. 获取并过滤当前语言的日志
const allLogs = await getCollection('changelog', ({ data }) => data.lang === lang);

// 4. 按日期倒序排序
const sortedLogs = allLogs.sort((a, b) =>
    new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// 类型对应的 Catppuccin 配色
const typeColors = {
    feat: 'bg-green-500/10 text-green-400 border-green-500/20',
    fix: 'bg-red-500/10 text-red-400 border-red-500/20',
    refactor: 'bg-[#89b4fa]/10 text-[#89b4fa] border-[#89b4fa]/20',
    style: 'bg-pink-500/10 text-pink-400 border-pink-500/20',
    perf: 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20'
};
---

<BaseLayout
        lang={lang}
        title={t('archive')}
        description={t('changelogIntro')}
>
    <div class="max-w-4xl mx-auto px-4">
        <header class="mb-16 border-b border-white/5 pb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-[#f5e0dc] mb-6 tracking-tight flex items-center gap-4">
                <Icon name="lucide:history" class="w-10 h-10 text-[#89b4fa]" />
                {t('archive')}
            </h1>
            <p class="text-[#bac2de] text-lg opacity-80 leading-relaxed font-medium">
                {t('changelogIntro')}
            </p>
        </header>

        <div class="relative ml-2 sm:ml-6 space-y-16 before:absolute before:inset-y-0 before:left-0 before:w-0.5 before:bg-gradient-to-b before:from-[#89b4fa] before:via-[#585b70] before:to-transparent pb-10">

            {sortedLogs.map((log) => (
                    <div class="relative group">
                        <div class="absolute -left-[9px] top-2 w-4 h-4 rounded-full border-4 border-[#1e1e2e] bg-[#89b4fa] shadow-[0_0_10px_rgba(137,180,250,0.5)] z-20 group-hover:scale-150 transition-transform duration-300"></div>

                        <div class="pl-8 mb-4">
                            <time class="text-sm font-mono font-bold tracking-tighter text-[#6c7086] group-hover:text-[#89b4fa] transition-colors flex items-center gap-2">
                                <Icon name="lucide:calendar" class="w-3.5 h-3.5" />
                                {log.data.date.replace(/-/g, '/')}
                            </time>
                        </div>

                        <div class="ml-8 bento-card p-6 md:p-10 border border-white/5 hover:border-[#89b4fa]/30 transition-all duration-500">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
                                <div class="flex flex-col gap-3">
                                    <div class="flex items-center gap-3">
                                    <span class={`text-[10px] uppercase tracking-widest font-black px-2 py-0.5 rounded border ${typeColors[log.data.type as keyof typeof typeColors]}`}>
                                        {log.data.type}
                                    </span>
                                        <div class="flex items-center gap-2 text-xs font-mono text-[#89b4fa]/60">
                                            <Icon name="lucide:tag" class="w-3 h-3" />
                                            {log.data.version}
                                        </div>
                                    </div>
                                    <h2 class="text-2xl md:text-3xl font-bold text-[#f5e0dc] group-hover:text-[#89b4fa] transition-colors leading-tight">
                                        {log.data.title}
                                    </h2>
                                </div>
                            </div>

                            <div class="prose prose-invert prose-sm md:prose-base max-w-none text-[#a6adc8]
                            prose-li:my-3 prose-li:leading-relaxed
                            prose-strong:text-[#f5e0dc] prose-strong:font-bold
                            prose-code:text-[#f5c2e7] prose-code:bg-white/5 prose-code:px-1 prose-code:rounded">
                                {/* 异步加载 Markdown 正文 */}
                                {log.render().then(({ Content }) => <Content />)}
                            </div>
                        </div>
                    </div>
            ))}
        </div>

        <div class="mt-20 pb-20"></div>
    </div>
</BaseLayout>

<style>
    /* 标准 CSS 属性，确保无语法错误 */
    .bento-card {
        backdrop-filter: blur(16px);
        background: linear-gradient(
                160deg,
                rgba(49, 50, 68, 0.4) 0%,
                rgba(30, 30, 46, 0.6) 100%
        );
    }

    /* 列表点美化 */
    .prose ul {
        list-style-type: none;
        padding-left: 0.5rem;
    }
    .prose li {
        position: relative;
        padding-left: 1.75rem;
    }
    .prose li::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0.7em;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #89b4fa;
        box-shadow: 0 0 8px rgba(137, 180, 250, 0.6);
    }
</style>